```{r, echo=FALSE}
library("RPostgreSQL")
library("tidyverse")
library("lubridate")
library("ggplot2")
```

```{r, echo=FALSE}
dsn_database = "basi24"
dsn_server = "localhost"
dsn_port = "5432"
dsn_uid = "postgres"
dsn_pswd = "postgres"

tryCatch({
    drv <- dbDriver("PostgreSQL")
    print("Connecting to Database...")
    connec <- dbConnect(drv,
                dbname = dsn_database,
                host = dsn_server,
                port = dsn_port,
                user = dsn_uid,
                password = dsn_pswd)
    print("Database Connected!")
},
error = function(cond) {
    print("Unable to connect to Database")
})
```

# Ottieni il numero di interventi per ogni anno

```{r, echo = FALSE}
intervento_df <- dbGetQuery(connec, "SELECT * FROM progetto_basi.intervento")

intervento_df <- intervento_df[order(intervento_df$data),]

interv_dist <-
    intervento_df %>% 
    group_by(data = lubridate::floor_date(data, 'year')) %>%
    summarize(numero_interventi = n())

interv_dist$data <- format(as.Date(interv_dist$data), "%Y")

ggplot(interv_dist, aes(data, numero_interventi, fill=data)) + 
    geom_bar(stat="identity") +
    theme_bw() +
    theme(text=element_text(size = 17))
```

# Ottieni il numero di interventi per tipo di problema

```{r, echo=FALSE}
distfreq_type_interv_df <- dbGetQuery(connec, "SELECT competenza as tipoproblema, COUNT(*) as numero_interventi 
                                                FROM progetto_basi.registrointerventi as r NATURAL JOIN progetto_basi.possiede as p
                                                GROUP BY tipoproblema")

ggplot(distfreq_type_interv_df, aes(tipoproblema, numero_interventi, fill=tipoproblema)) + 
    geom_bar(stat="identity") +
    theme_bw() +
    theme(text=element_text(size = 17), panel.grid.major = element_blank(), panel.grid.minor = element_blank())

```

# Ottieni la distribuzione di frequenza degli interventi effettuati dai singoli tecnici nel 2020

```{r, echo=FALSE}
raw_df <- dbGetQuery(connec, "SELECT tecnico, n_interventi
                                                        FROM (SELECT tecnico, count(*) as n_interventi
                                                            FROM progetto_basi.RegistroInterventi as r, progetto_basi.Intervento as i 
                                                            WHERE r.richiesta = i.richiesta AND r.intervento = i.nintervento AND i.data > '2020-1-1' AND i.data < '2021-1-1'
                                                            GROUP BY tecnico)
                                                        ORDER BY n_interventi DESC")

distfreq_technician_interv_df <-
    raw_df %>%
    mutate(freq = (n_interventi / sum(raw_df$n_interventi)) * 100) %>%
    mutate(across(where(is.numeric), ~ round(., 3)))

ggplot(distfreq_technician_interv_df, aes(x="", y=n_interventi, fill=tecnico)) +
    geom_bar(stat="identity", width=1) +
    coord_polar("y", start=0) +
    geom_text(aes(label = paste0(freq, "%")), position = position_stack(vjust=0.5)) +
    labs(x = NULL, y = NULL, fill = NULL) +
    theme_void()
```