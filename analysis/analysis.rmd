```{r, echo=FALSE}
library("RPostgreSQL")
library("tidyverse")
library("lubridate")
library("ggplot2")
```

```{r, echo=FALSE}
dsn_database = "postgres"
dsn_server = "120."
dsn_port = "5433"
dsn_uid = "postgres"
dsn_pswd = "postgres"

tryCatch({
    drv <- dbDriver("PostgreSQL")
    print("Connecting to Database...")
    connec <- dbConnect(drv,
                dbname = dsn_database,
                host = dsn_server,
                port = dsn_port,
                user = dsn_uid,
                password = dsn_pswd)
    print("Database Connected!")
},
error = function(cond) {
    print("Unable to connect to Database")
})
```

# Ottieni il numero di interventi per ogni anno

```{r, echo = FALSE}
interv_dist <- dbGetQuery(connec, "SELECT EXTRACT(year FROM data) as anno, 
                                        count(*) as n_interventi
                                    FROM basi.intervento 
                                    GROUP BY anno
                                    ORDER BY anno")

interv_dist$legend <- factor(interv_dist$anno, levels = c(2019, 2020, 2021))

ggplot(interv_dist, aes(anno, n_interventi, fill=legend)) + 
    geom_bar(stat="identity") +
    theme_bw() +
    theme(text=element_text(size = 17))
```

# Ottieni il numero di interventi per ogni mese in ordine cronologico

```{r, echo = FALSE}
intervento_df <- dbGetQuery(connec, "SELECT * FROM basi.intervento")

intervento_df <- intervento_df[order(intervento_df$data),]

interv_dist <-
    intervento_df %>% 
    group_by(data = lubridate::floor_date(data, 'month')) %>%
    summarize(numero_interventi = n())

# palette is a set of 36 colors used to color the 36 dots 
palette <- rep(c("blue", "red", ...), length.out = 36)

# in order to map values into colors, as.factor(data) is used
ggplot(interv_dist, aes(x = data, y = numero_interventi, color = as.factor(data), group = 1)) +  
    geom_point() +
    scale_fill_manual(values = palette) +
    geom_line()

#ggsave(file = "graf.png", width = 15, heigth = 5,dpi = 150)

```

# Ottieni il numero di interventi per tipo di problema

```{r, echo=FALSE}
distfreq_type_interv_df <- dbGetQuery(connec, "SELECT competenza as tipoproblema, COUNT(*) as numero_interventi 
                                                FROM basi.registrointerventi as r NATURAL JOIN basi.possiede as p
                                                GROUP BY tipoproblema")

ggplot(distfreq_type_interv_df, aes(tipoproblema, numero_interventi, fill=tipoproblema)) + 
    geom_bar(stat="identity") +
    theme_bw() +
    theme(text=element_text(size = 17), panel.grid.major = element_blank(), panel.grid.minor = element_blank())

```

# Ottieni la distribuzione di frequenza degli interventi effettuati dai singoli tecnici nel 2020

```{r, echo=FALSE}
raw_df <- dbGetQuery(connec, "SELECT t1.tecnico, t1.n_interventi
                            FROM (SELECT tecnico, count(*) as n_interventi
                                FROM basi.RegistroInterventi as r, basi.Intervento as i 
                                WHERE r.richiesta = i.richiesta AND r.intervento = i.nintervento AND i.data > '2020-1-1' AND i.data < '2021-1-1'
                                GROUP BY tecnico) t1
                            ORDER BY t1.n_interventi DESC")

distfreq_technician_interv_df <-
    raw_df %>%
    mutate(freq = (n_interventi / sum(raw_df$n_interventi)) * 100) %>%
    mutate(across(where(is.numeric), ~ round(., 3)))

ggplot(distfreq_technician_interv_df, aes(x="", y=n_interventi, fill=tecnico)) +
    geom_bar(stat="identity", width=1) +
    coord_polar("y", start=0) +
    geom_text(aes(label = paste0(freq, "%")), position = position_stack(vjust=0.5)) +
    labs(x = NULL, y = NULL, fill = NULL) +
    theme_void()
```

# Ottieni il numero di intervento per tipo problema dei 5 clienti con pi√π interventi registrati

```{r, echo=FALSE}
best_client_df <- dbGetQuery(connec, "SELECT cliente, tipoproblema, COUNT(*) as nInterventi 
                                        FROM basi.registrointerventi JOIN basi.richiesta on npratica = registrointerventi.richiesta
                                        WHERE cliente in (
                                                    SELECT cliente
                                                    FROM (SELECT cliente, tipoproblema, COUNT(*) as nInterventi 
                                                            FROM basi.registrointerventi JOIN basi.richiesta on npratica = registrointerventi.richiesta
                                                            GROUP BY (cliente, tipoproblema)
                                                            ORDER BY nInterventi) t1
                                                    GROUP BY (cliente)
                                                    Order BY (SUM(nInterventi)) DESC
                                                    LIMIT 5)
                                            GROUP BY (cliente,tipoproblema);")


best_client_df$cliente <- as.character(best_client_df$cliente)
array <- paste("cliente", unique(best_client_df$cliente) , sep = "_")

ggplot(best_client_df, aes(fill = tipoproblema, y = ninterventi, x = cliente)) +
  geom_bar(position='dodge', stat='identity') +
  scale_x_discrete(labels = array)
```